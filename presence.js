#!/usr/bin/env node

const RPC = require('discord-rpc')
const chalk = require('chalk')
const fs = require('fs')
const os = require('os')

let client = new RPC.Client({ transport: 'ipc' })

const dir = `${os.userInfo().homedir}/${process.platform === 'win32' ? '/AppData/Roaming' : '/.config'}`
const options = require(`${dir}/drpcm-options.json`)

// console.log(options);

const activity = {}
const assets = {}

if (options.largeimage !== '') {
	assets.large_image = options.largeimage
	// If you change this and some asks about this, please still give me credit :)
	assets.large_text = "Made with ThatOneCalculator's Discord RPC Maker (v1.8.2)!"
}
if (options.smallimage !== '') {
	assets.small_image = options.smallimage
	// Same applies with assets.large_text
	assets.small_text = 'https://drpcm.t1c.dev/'
}
if (assets !== {}) { activity.assets = assets }
if (options.description !== '') { activity.details = options.description }
if (options.state !== '') { activity.state = options.state }
if (options.buttons.length !== 0) { activity.buttons = options.buttons }

function assembleClient(timeout = 5000) {
	client.destroy()
	client = new RPC.Client({ transport: 'ipc' })
	client.on('ready', () => {
		running = true;
		client.request('SET_ACTIVITY', {
			pid: process.pid,
			activity: activity
		})
		/*
		notifier.notify({
			title: 'Discord RPC Maker',
			message: 'Your Rich Presence has started!',
			sound: true
		})
		*/
		console.log(chalk`{bold.green Your Rich Presence has started!} Generated by {blue.underline https://github.com/ThatOneCalculator/DiscordRPCMaker}`)
		client.transport.socket.on("close", (c,s) => {
			console.log(chalk`{bold.red Connection closed. }{green Attempting to reopen in 5 seconds.}`)
			assembleClient()
		})
	})
	setTimeout(() => client.login({ clientId: options.clientid }), timeout)
}

process.on("unhandledRejection", e => {
	if (e.message === "Could not connect") {
		console.log(chalk`{bold.red Failed to connect.}\n{bold.green Retrying in 5 seconds.}`)
		assembleClient()
	}
})

assembleClient(0)
